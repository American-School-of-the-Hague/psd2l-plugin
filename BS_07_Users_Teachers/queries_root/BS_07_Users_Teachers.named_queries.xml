<queries>
	<!--set name here (also applies to permissions_root-->
    <query name="com.txoof.brightspace.teachers.usernames" coreTable="teachers" flattened="false">
		<!--add description here-->
        <description>export all active students grades 5-13 for use with a BrightSpace 7-User import</description>
		<!--number of columns here must match number sql returns-->
        <columns>
			<column column="TEACHERS.ID">type</column> <!-- for columns not in database use a core filed-->
			<column column="TEACHERS.ID">action</column> <!-- for columns not in database use a core filed-->
			<column column="TEACHERS.EMAIL_ADDR">username</column> 
			<column column="TEACHERS.ID">org_defined_id</column>
			<column column="TEACHERS.FIRST_NAME">first_name</column>
			<column column="TEACHERS.LAST_NAME">last_name</column>
			<column column="TEACHERS.ID">password</column>
			<column column="STUDENTS.ENROLL_STATUS">is_active</column>
			<column column="TEACHERS.ID">role_name</column>
			<column column="TEACHERS.ID">relationships</column>
			<column column="TEACHERS.ID">pref_first_name</column>
			<column column="TEACHERS.ID">pref_last_name</column>
			<column column="TEACHERS.EMAIL_ADDR">email</column>
 		</columns>
		<!--SQL query in format <![CDATA[QUERY]]>-->
        <sql>
			<![CDATA[
			select 
				'user' as "type",
				'UPDATE' as "action",
				REGEXP_REPLACE(TEACHERS.EMAIL_ADDR, '(^.*)(@.*)', '\1') as "username",
				TEACHERS.ID as "org_defined_id",
				TEACHERS.FIRST_NAME as "first_name",
				TEACHERS.LAST_NAME as "last_name",
				'' as "password",
				TEACHERS.STATUS as "is_active",
				'Instructor' as "role_name",
				TEACHERS.EMAIL_ADDR as "email",
				'' as "relationships",
				'' as "pref_first_name",
				'' as "pref_last_name"

			from TEACHERS TEACHERS
			where TEACHERS.HOMESCHOOLID = TEACHERS.SCHOOLID 
				AND TEACHERS.STATUS = 1 
				/* Ignore all users with no email address */
				AND LENGTH(TEACHERS.EMAIL_ADDR) > 0
				ORDER BY TEACHERS.LAST_NAME ASC
			]]>
        </sql>
    </query>

</queries>