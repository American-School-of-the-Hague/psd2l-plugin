<queries>
	<!--set name here (also applies to permissions_root-->
    <query name="com.txoof.brightspace.users.c07g_inactive" coreTable="guardian" flattened="false">
		<!--add description here-->
        <description>export all inactive parents grades 5-13 for use with a BrightSpace 7-User import</description>
		<!--number of columns here must match number sql returns-->
        <columns>
            <!--for an unknown reason using GUARDIAN.GUARDIANID causes this plugin to fail falling back to STUDENTS.ID. THIS WORKS BECAUSE???-->
			<column column="STUDENTS.ID">type</column> <!-- for columns not in database use a core filed-->
			<column column="STUDENTS.ID">action</column> <!-- for columns not in database use a core filed-->
			<column column="STUDENTS.ID">username</column> 
			<column column="STUDENTS.ID">org_defined_id</column>
			<column column="STUDENTS.FIRST_NAME">first_name</column>
			<column column="STUDENTS.LAST_NAME">last_name</column>
			<column column="STUDENTS.ID">password</column>
			<column column="STUDENTS.ENROLL_STATUS">is_active</column>
			<column column="STUDENTS.ID">role_name</column>
			<column column="STUDENTS.ID">email</column>
			<column column="STUDENTS.ID">relationships</column>
			<column column="STUDENTS.ID">pref_first_name</column>
			<column column="STUDENTS.ID">pref_last_name</column>
        </columns>
		<!--SQL query in format <![CDATA[QUERY]]>-->
        <sql>
			<![CDATA[
            SELECT distinct
                'user' as "type",
                -- delete guardians that have departed more than N days ago
                case when (trunc(sysdate) - s.exitdate) > 30
                    then 'DELETE'
                    else 'UPDATE'
                end as "action",
                lower(ema.emailaddress) as "username",
                'P_'||gs.guardianid as "org_defined_id",
                p.firstname as "first_name",
                p.lastname as "last_name",
                '' as "password",
                0 as "is_active",
                'Parent' as "role_name",
                lower(EMA.emailaddress) as "email",
                '' as "relationships",
                '' as "pref_first_name",
                '' as "pref_last_name"
            FROM
                students s
                JOIN studentcontactassoc sca ON s.dcid = sca.studentdcid
                join personemailaddressassoc PEAA on sca.personid = PEAA.personid
                join emailaddress EMA on PEAA.emailaddressid = EMA.emailaddressid
                JOIN person p ON sca.personid = p.id
                join guardianstudent gs on s.dcid = gs.studentsdcid
                join guardianpersonassoc GPA on p.id = GPA.personid
            WHERE
                s.enroll_status > 0
                and s.grade_level >= 5
                /*
                if the count of the associated students is less than 1, there are no 
                active students enrolled at ASH. 
                */
                and (
                    SELECT COUNT(s_inner.enroll_status)
                    FROM studentcontactassoc sca_inner
                    JOIN students s_inner ON s_inner.dcid = sca_inner.studentdcid
                    WHERE sca_inner.personid = sca.personid
                    AND s_inner.enroll_status <= 0
                ) < 1
                -- use the firstday of the highest term for this calculation
                AND s.exitdate > (
                    SELECT firstday
                    FROM terms
                    WHERE yearid = (SELECT MAX(yearid) FROM terms WHERE schoolid = 3 AND MOD(id, 100) = 0)
                    AND schoolid = 3
                    AND MOD(id, 100) = 0
                )
			]]>
        </sql>
    </query>

</queries>